<!-- Loading overlay -->
<div *ngIf="loading" class="loading-overlay">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
</div>

<!-- Main Content -->
<div *ngIf="!loading" class="container mt-4 d-flex flex-column gap-4" style="height: auto;">
  <!-- Card l·ªçc + th·ªëng k√™ -->
  <div class="card shadow-sm rounded-4 p-4 d-flex flex-row gap-4 align-items-start">
    <!-- Sidebar l·ªçc -->
    <div class="filter-sidebar">
      <div class="mb-4">
        <label class="form-label fw-semibold">Lo·∫°i bi·ªÉu ƒë·ªì</label>
        <select class="form-select" [(ngModel)]="selectedChartType" (change)="updateChartType()">
          <option value="line">Bi·ªÉu ƒë·ªì ƒë∆∞·ªùng</option>
          <option value="bar">Bi·ªÉu ƒë·ªì c·ªôt</option>
        </select>
      </div>
      <div class="mb-4">
        <label class="form-label fw-semibold">NƒÉm</label>
        <select class="form-select" [(ngModel)]="filterYear" (change)="applyFilters()">
          <option value="">T·∫•t c·∫£ c√°c nƒÉm</option>
          <option *ngFor="let y of years" [value]="y">{{ y }}</option>
        </select>
      </div>
      <div>
        <label class="form-label fw-semibold">Ng∆∞·ªùi d√πng</label>
        <select class="form-select" [(ngModel)]="filterUser" (change)="applyFilters()">
          <option value="">T·∫•t c·∫£ ng∆∞·ªùi d√πng</option>
          <option *ngFor="let u of users" [value]="u.id">{{ u.fullname }}</option>
        </select>
      </div>
    </div>

    <!-- Vertical Divider -->
    <div class="vr" style="height: 100%; width: 2px; background-color: #dee2e6;"></div>

    <!-- Th·ªëng k√™ -->
    <div class="flex-grow-1 d-flex flex-column gap-4">
      <h5 class="mb-2 text-primary fw-bold text-center">
        <ng-container *ngIf="!filterUser; else userStats">
          üèÜ Top 3 Ng∆∞·ªùi d√πng ti√™u d√πng nhi·ªÅu nh·∫•t
        </ng-container>
        <ng-template #userStats>
          üìä Th·ªëng k√™ nhanh ng∆∞·ªùi d√πng
        </ng-template>
      </h5>

      <ng-container *ngIf="!filterUser">
        <ng-container *ngIf="top3Users?.length; else noUser">
          <div class="d-flex flex-column gap-3">
            <div *ngFor="let user of top3Users; let i = index" class="card p-3 shadow-sm"
              [ngClass]="{ 'rank-1': i === 0, 'rank-2': i === 1, 'rank-3': i === 2 }">
              <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex justify-content-between align-items-center">
                  <div class="fw-semibold d-flex align-items-center gap-2" [ngClass]="{
                      'text-gold': i === 0,
                      'text-silver': i === 1,
                      'text-bronze': i === 2
                    }">
                    <ng-container [ngSwitch]="i">
                      <i *ngSwitchCase="0" class="fas fa-medal" title="H·∫°ng 1" style="color: #f59e0b;"></i>
                      <i *ngSwitchCase="1" class="fas fa-medal" title="H·∫°ng 2" style="color: #9ca3af;"></i>
                      <i *ngSwitchCase="2" class="fas fa-medal" title="H·∫°ng 3" style="color: #cd7f32;"></i>
                      <i *ngSwitchDefault class="fas fa-medal" style="visibility: hidden;"></i>
                    </ng-container>
                    {{ i + 1 }}. {{ user.fullname }}
                  </div>

                </div>
                <div [ngClass]="{
                    'text-gold': i === 0,
                    'text-silver': i === 1,
                    'text-bronze': i === 2
                  }" class="fw-bold">
                  {{ user.income | currency: 'VND' : 'symbol' }}
                </div>
              </div>
            </div>
          </div>
        </ng-container>
        <ng-template #noUser>
          <p class="text-muted">Ch∆∞a c√≥ d·ªØ li·ªáu ph√π h·ª£p.</p>
        </ng-template>
      </ng-container>

      <ng-container *ngIf="filterUser">
        <div class="d-flex justify-content-center align-items-center" style="height: 200px;">
          <div class="row text-center" style="width: 100%; max-width: 900px;">
            <div class="col-md-4 mb-3 mb-md-0 d-flex justify-content-center">
              <div class="p-4 rounded shadow-sm"
                style="height: 120px; width: 100%; max-width: 250px; background-color: #3b5998;">
                <!-- m√†u xanh ƒë·∫≠m h∆°n -->
                <h5 class="mb-2 flex-wrap" style="font-weight: 600; color: #ffffff;">Ng∆∞·ªùi d√πng</h5>
                <h3 class="text-white flex-wrap">{{ userMap[filterUser] || 'Kh√¥ng r√µ' }}</h3>
              </div>
            </div>
            <div class="col-md-4 mb-3 mb-md-0 d-flex justify-content-center">
              <div class="p-4 rounded shadow-sm"
                style="height: 120px; width: 100%; max-width: 250px; background-color: #2e7d32;"> <!-- xanh l√° ƒë·∫≠m -->
                <h5 class="mb-2 flex-wrap" style="font-weight: 600; color: #ffffff;">S·ªë l∆∞·ª£ng ƒë∆°n h√†ng</h5>
                <h3 class="text-white flex-wrap">{{ userOrderCount || 0 }}</h3>
              </div>
            </div>
            <div class="col-md-4 d-flex justify-content-center">
              <div class="p-4 rounded shadow-sm"
                style="height: 120px; width: 100%; max-width: 250px; background-color: #0288d1;"> <!-- xanh bi·ªÉn ƒë·∫≠m -->
                <h5 class="mb-2 flex-wrap" style="font-weight: 600; color: #ffffff;">T·ªïng thu nh·∫≠p</h5>
                <h3 class="text-white flex-wrap">{{ userTotalIncome | currency: 'VND': 'symbol' }}</h3>
              </div>
            </div>
          </div>
        </div>
      </ng-container>
    </div>
  </div>

  <!-- Bi·ªÉu ƒë·ªì -->
  <div class="card shadow-sm rounded-4 w-100">
    <div class="card-body p-4">
      <canvas id="incomeMonthChart" style="max-height: 400px; width: 100%;"></canvas>
    </div>
  </div>
</div>